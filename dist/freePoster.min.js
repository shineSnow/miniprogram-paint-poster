!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("Taro")):"function"==typeof define&&define.amd?define(["Taro"],t):"object"==typeof exports?exports.FreePoster=t(require("Taro")):e.FreePoster=t(e.Taro)}(window,function(n){return r={},o.m=a=[function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n,a=arguments[t];for(n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},a=function(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e};function o(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}var r,s=n(1),i=(r=s)&&r.__esModule?r:{default:r};function c(e){return function(){var i=e.apply(this,arguments);return new Promise(function(r,s){return function t(e,n){try{var a=i[e](n),o=a.value}catch(e){return void s(e)}if(!a.done)return Promise.resolve(o).then(function(e){t("next",e)},function(e){t("throw",e)});r(o)}("next")})}}var l,u,h,v,f,a=(a(g,[{key:"paintImg",value:(f=c(regeneratorRuntime.mark(function e(t){var n,a,o,r,s,i,c=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.src,a=t.x,o=t.y,r=t.width,s=t.height,e.next=3,this._downloadFile(n);case 3:return i=e.sent,this.params.debug&&console.log("开始绘制图片",i),e.abrupt("return",new Promise(function(e,t){try{c.canvasContext.drawImage(i,a,o,r,s),c.params.debug&&console.log("开始绘制图片完成"),e()}catch(e){t(e)}c.canvasContext.draw(!0)}));case 6:case"end":return e.stop()}},e,this)})),function(e){return f.apply(this,arguments)})},{key:"drawPaddingCircleImg",value:(v=c(regeneratorRuntime.mark(function e(t){var n,a,o,r,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t.src,n=t.x,a=t.y,o=t.width,r=t.height,t.backgroundColor,s=t.padding,s=Object.assign({},t,{x:n-s,y:a-s,width:o+2*s,height:r+2*s}),e.next=4,this.paintCircleShape(s);case 4:return e.next=6,this.paintCircleImage(t);case 6:case"end":return e.stop()}},e,this)})),function(e){return v.apply(this,arguments)})},{key:"paintCircleImage",value:(h=c(regeneratorRuntime.mark(function e(t){var n,a,o,r,s,i,c,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return l=t.src,n=t.x,a=t.y,o=t.width,r=t.height,e.next=3,this._downloadFile(l);case 3:s=e.sent,i=n+o/2,c=a+r/2,l=r/2,this.canvasContext.save(),this.canvasContext.beginPath(),this.canvasContext.arc(i,c,l,0,2*Math.PI),this.canvasContext.clip(),this.canvasContext.drawImage(s,n,a,o,r),this.canvasContext.restore(),this.canvasContext.draw(!0);case 14:case"end":return e.stop()}},e,this)})),function(e){return h.apply(this,arguments)})},{key:"paintCircleShape",value:function(e){this.params.debug&&console.log("开始绘制圆形o",e);var t=e.x,n=e.y,a=e.width,o=e.height,r=e.backgroundColor,e=void 0,s=t+a/2,i=n+o/2,e=o/2;this.canvasContext.save(),this.canvasContext.beginPath(),this.canvasContext.arc(s,i,e,0,2*Math.PI),this.canvasContext.clip(),this.canvasContext.setFillStyle(r),this.canvasContext.fillRect(t,n,a,o),this.canvasContext.restore()}},{key:"paintRectShape",value:function(e){this.params.debug&&console.log("开始绘制矩形",e);var t=e.x,n=e.y,a=e.width,o=e.height,e=e.backgroundColor;this.canvasContext.save(),this.canvasContext.setFillStyle(e),this.canvasContext.fillRect(t,n,a,o),this.canvasContext.restore()}},{key:"paintOneLineText",value:function(e){this.params.debug&&console.log("开始绘制单行文字",e);var t=e.x,n=e.y,a=e.fontSize,o=e.color,r=e.MaxTextNum,s=e.txt,e=e.font||"";this.canvasContext.save(),this.canvasContext.setTextAlign("left"),this.canvasContext.setFontSize(a),this.canvasContext.setFillStyle(o),this.canvasContext.font=e||'normal "Helvetica Neue",Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif';e=this.canvasContext.measureText(s).width;this.params.debug&&console.log("单行文字的宽度--"+s,e),this.params.debug&&console.log("文字的位数--"+s,s.length),s&&r&&r<s.length&&(s=s.substr(0,r)+"..."),this.canvasContext.fillText(s,t,n),this.canvasContext.restore(),this.canvasContext.draw(!0)}},{key:"paintCircularText",value:function(e){this.params.debug&&console.log("开始绘制环形文字",e);var t=e.txt,n=(e.x,e.y,e.fontSize),a=e.color,o=e.circularH,r=e.circularW,s=e.circularColor,i=e.circularY,c=this.canvasContext.measureText(t).width,l=(this.params.width-r)/2;this.params.debug&&console.log("环形文字的宽度--"+t,c),this.params.debug&&console.log("环形的宽度",r);e=o/2,c=r/2;this.canvasContext.setFillStyle(s),this.canvasContext.arc(l,i+e,e,0,2*Math.PI),this.canvasContext.arc(l+r,i+e,e,0,2*Math.PI),this.canvasContext.rect(l,i,r,o),this.canvasContext.fill(),this.canvasContext.setFillStyle(a),this.canvasContext.setFontSize(n),this.canvasContext.setTextAlign("center"),this.canvasContext.fillText(t,l+c,i+e+n/4+2),this.canvasContext.draw(!0)}},{key:"paintMultiLine",value:function(e){this.params.debug&&console.log("开始多行文本",e);var t=e.txt,n=(e.x,e.y),a=(e.fontSize,e.color,e.lineDistance),o=void 0===a?36:a,r=e.oneLineTextNum;if(t){var s=t,t=t.length;if(r>s.length)return console.error("多行文本字数 < 设置的允许单行文字的字数",e),void this.paintOneLineText(e);for(var i=[],c=Math.ceil(t/r),l=0;l<c;l++){var u=s.slice(l*r,(l+1)*r);i.push(u)}this.params.debug&&console.log("多行文本的分割结果",i);for(var h=0;h<i.length;h++){var v=i[h],v=p({},e,{y:n+h*o,txt:v});this.paintOneLineText(v)}}}},{key:"paintBorderCircularText",value:function(e){this.params.debug&&console.log("开始绘制环形文字",e);var t=e.txt,n=(e.x,e.y,e.fontSize),a=e.color,o=e.borderColor,r=e.circularH,s=e.circularW,i=(e.circularColor,e.circularX),c=e.circularY,l=this.canvasContext.measureText(t).width;this.params.debug&&console.log("环形文字的宽度--"+t,l),this.params.debug&&console.log("环形的宽度",s);e=r/2,l=s/2;this.canvasContext.setStrokeStyle(o||"red"),this.canvasContext.arc(i,c+e,e,.5*Math.PI,1.5*Math.PI),this.canvasContext.arc(i+s,c+e,e,1.5*Math.PI,.5*Math.PI),this.canvasContext.moveTo(i,c),this.canvasContext.lineTo(i+s,c),this.canvasContext.moveTo(i,c+r),this.canvasContext.lineTo(i+s,c+r),this.canvasContext.stroke(),this.canvasContext.setFillStyle(a),this.canvasContext.setFontSize(n),this.canvasContext.setTextAlign("center"),this.params.debug&&console.log("环形文字的坐标--x:"+(i+l)+",y:"+(c+e+n/4+2)),this.canvasContext.fillText(t,i+l,c+e+n/4+2),this.canvasContext.draw(!0)}},{key:"previewPoster",value:(u=c(regeneratorRuntime.mark(function e(){var n=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._canvasToTempFilePath();case 2:return console.log("预览海报,海报临时地址:",this.posterImgSrc),e.abrupt("return",new Promise(function(e,t){n.posterImgSrc?i.default.previewImage({current:n.posterImgSrc,urls:[n.posterImgSrc]}).then(function(){e()}).catch(function(e){t(e)}):(console.log("海报图地址获取失败,海报临时地址:",n.posterImgSrc),t("海报图地址获取失败,海报临时地址:"))}));case 4:case"end":return e.stop()}},e,this)})),function(){return u.apply(this,arguments)})},{key:"savePosterToPhoto",value:(l=c(regeneratorRuntime.mark(function e(){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=this,e.next=3,this._canvasToTempFilePath();case 3:return a=this.posterImgSrc,this.params.debug&&(console.time("canvas图片保存"),console.log("开始保存图片到相册",a)),e.abrupt("return",new Promise(function(e,t){i.default.saveImageToPhotosAlbum({filePath:a,success:function(){i.default.hideToast(),e("图片保存到相册"),console.log("成功保存图片到相册",a),n.params.debug&&console.timeEnd("canvas图片保存")},fail:function(e){console.log(333,e),i.default.hideLoading(),console.log(444,e),n.getAuth(),t(e)}})}));case 6:case"end":return e.stop()}},e,this)})),function(){return l.apply(this,arguments)})},{key:"getAuth",value:function(){i.default.hideLoading(),this.params.debug&&console.log("拒绝保存"),i.default.showModal({content:"需要您授权保存相册",confirmColor:"#E23A4E",showCancel:!1,success:function(e){i.default.openSetting({success:function(e){console.log("settingdata",e),e.authSetting["scope.writePhotosAlbum"]?i.default.showToast({title:"获取权限成功,再次点击图片即可保存",icon:"none",duration:3e3}):i.default.showToast({title:"获取权限失败，将无法保存到相册",icon:"none",duration:3e3})},fail:function(e){console.log("failData",e)},complete:function(e){console.log("finishData",e)}})}})}},{key:"_downloadFile",value:function(o){var n,r=this;return this.params.debug&&(console.log("开始下载网络图片",o),console.time("网络图片下载时间",o)),-1==o.indexOf("http")?Promise.resolve(o):new Promise((n=c(regeneratorRuntime.mark(function e(t,n){var a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,i.default.downloadFile({url:o});case 3:a=e.sent,r.params.debug&&(console.log("网络图片下载成功",a.tempFilePath),console.timeEnd("网络图片下载时间",o)),t(a.tempFilePath),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),r.params.debug&&console.log("网络图片下载失败"),n(e.t0);case 12:case"end":return e.stop()}},e,r,[[0,8]])})),function(e,t){return n.apply(this,arguments)}))}},{key:"_canvasToTempFilePath",value:function(){var o=this;return this.posterImgSrc?(console.log("canvas临时文件已存在",this.posterImgSrc),Promise.resolve(this.posterImgSrc)):new Promise(function(n,a){setTimeout(c(regeneratorRuntime.mark(function e(){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o.params.debug&&(console.log("开始截取canvas目前的图像"),console.time("canvas截取图片")),e.next=4,i.default.canvasToTempFilePath({x:0,y:0,quality:o.params.quality,canvasId:o.params.canvasId});case 4:t=e.sent,o.params.debug&&(console.log("截取canvas目前的图像成功",t.tempFilePath),console.timeEnd("canvas截取图片")),o.posterImgSrc=t.tempFilePath,n(),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(0),a(e.t0);case 13:case"end":return e.stop()}},e,o,[[0,10]])})),300)})}}]),g);function g(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,g);this.params=Object.assign({x:0,y:0,width:750,height:1334,quality:1,canvasId:"posterCanvasId",debug:!1,canvasBackground:"rgba(0, 0, 0, 0.1)"},e),this.canvasContext=i.default.createCanvasContext(this.params.canvasId),this.posterImgSrc=""}t.default=a},function(e,t){e.exports=n}],o.c=r,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(o.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)o.d(n,a,function(e){return t[e]}.bind(null,a));return n},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=0).default;function o(e){if(r[e])return r[e].exports;var t=r[e]={i:e,l:!1,exports:{}};return a[e].call(t.exports,t,t.exports,o),t.l=!0,t.exports}var a,r});