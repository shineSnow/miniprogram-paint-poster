!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("Taro")):"function"==typeof define&&define.amd?define(["Taro"],e):"object"==typeof exports?exports.FreePoster=e(require("Taro")):t.FreePoster=e(t.Taro)}(window,function(a){return n={},o.m=s=[function(t,e,a){"use strict";a.r(e);var s=a(1),o=a.n(s);e.default=class{constructor(t){this.params=Object.assign({x:0,y:0,width:750,height:1334,quality:1,canvasId:"posterCanvasId",debug:!1,canvasBackground:"rgba(0, 0, 0, 0.1)"},t),this.canvasContext=o.a.createCanvasContext(this.params.canvasId),this.posterImgSrc=""}async paintImg(t){const{src:e,x:a,y:s,width:o,height:n}=t,i=await this._downloadFile(e);return this.params.debug&&console.log("开始绘制图片",i),new Promise((t,e)=>{try{this.canvasContext.drawImage(i,a,s,o,n),this.params.debug&&console.log("开始绘制图片完成"),t()}catch(t){e(t)}this.canvasContext.draw(!0)})}async drawPaddingCircleImg(t){var{x:e,y:a,width:s,height:o,padding:n}=t,n=Object.assign({},t,{x:e-n,y:a-n,width:s+2*n,height:o+2*n});await this.paintCircleShape(n),await this.paintCircleImage(t)}async paintCircleImage(t){var{src:e,x:a,y:s,width:o,height:n}=t,i=await this._downloadFile(e),r=a+o/2,t=s+n/2,e=n/2;this.canvasContext.save(),this.canvasContext.beginPath(),this.canvasContext.arc(r,t,e,0,2*Math.PI),this.canvasContext.clip(),this.canvasContext.drawImage(i,a,s,o,n),this.canvasContext.restore(),this.canvasContext.draw(!0)}paintCircleShape(t){this.params.debug&&console.log("开始绘制圆形o",t);var{x:e,y:a,width:s,height:o,backgroundColor:n}=t,i=e+s/2,r=a+o/2,t=o/2;this.canvasContext.save(),this.canvasContext.beginPath(),this.canvasContext.arc(i,r,t,0,2*Math.PI),this.canvasContext.clip(),this.canvasContext.setFillStyle(n),this.canvasContext.fillRect(e,a,s,o),this.canvasContext.restore()}paintRectShape(t){this.params.debug&&console.log("开始绘制矩形",t);var{x:e,y:a,width:s,height:o,backgroundColor:t}=t;this.canvasContext.save(),this.canvasContext.setFillStyle(t),this.canvasContext.fillRect(e,a,s,o),this.canvasContext.restore()}paintOneLineText(t){this.params.debug&&console.log("开始绘制单行文字",t);var{x:e,y:a,fontSize:s,color:o,MaxTextNum:n}=t;let i=t.txt;t=t.font||"";this.canvasContext.save(),this.canvasContext.setTextAlign("left"),this.canvasContext.setFontSize(s),this.canvasContext.setFillStyle(o),this.canvasContext.font=t||'normal "Helvetica Neue",Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif';t=this.canvasContext.measureText(i).width;this.params.debug&&console.log("单行文字的宽度--"+i,t),this.params.debug&&console.log("文字的位数--"+i,i.length),i&&n&&n<i.length&&(i=i.substr(0,n)+"..."),this.canvasContext.fillText(i,e,a),this.canvasContext.restore(),this.canvasContext.draw(!0)}paintCircularText(t){this.params.debug&&console.log("开始绘制环形文字",t);var{txt:e,fontSize:a,color:s,circularH:o,circularW:n,circularColor:i,circularY:r}=t,c=this.canvasContext.measureText(e).width,l=(this.params.width-n)/2;this.params.debug&&console.log("环形文字的宽度--"+e,c),this.params.debug&&console.log("环形的宽度",n);t=o/2,c=n/2;this.canvasContext.setFillStyle(i),this.canvasContext.arc(l,r+t,t,0,2*Math.PI),this.canvasContext.arc(l+n,r+t,t,0,2*Math.PI),this.canvasContext.rect(l,r,n,o),this.canvasContext.fill(),this.canvasContext.setFillStyle(s),this.canvasContext.setFontSize(a),this.canvasContext.setTextAlign("center"),this.canvasContext.fillText(e,l+c,r+t+a/4+2),this.canvasContext.draw(!0)}paintMultiLine(s){this.params.debug&&console.log("开始多行文本",s);var{txt:t,y:o,lineDistance:n=36,oneLineTextNum:i}=s;if(t){let e=t;t=t.length;if(i>e.length)return console.error("多行文本字数 < 设置的允许单行文字的字数",s),void this.paintOneLineText(s);let a=[];var r=Math.ceil(t/i);for(let t=0;t<r;t++){var c=t*i,l=(t+1)*i,h=e.slice(c,l);a.push(h)}this.params.debug&&console.log("多行文本的分割结果",a);for(let t=0;t<a.length;t++){var u=a[t],g=o+t*n,u={...s,y:g,txt:u};this.paintOneLineText(u)}}}paintBorderCircularText(t){this.params.debug&&console.log("开始绘制环形文字",t);var{txt:e,fontSize:a,color:s,borderColor:o,circularH:n,circularW:i,circularX:r,circularY:c}=t,l=this.canvasContext.measureText(e).width;this.params.debug&&console.log("环形文字的宽度--"+e,l),this.params.debug&&console.log("环形的宽度",i);t=n/2,l=i/2;this.canvasContext.setStrokeStyle(o||"red"),this.canvasContext.arc(r,c+t,t,.5*Math.PI,1.5*Math.PI),this.canvasContext.arc(r+i,c+t,t,1.5*Math.PI,.5*Math.PI),this.canvasContext.moveTo(r,c),this.canvasContext.lineTo(r+i,c),this.canvasContext.moveTo(r,c+n),this.canvasContext.lineTo(r+i,c+n),this.canvasContext.stroke(),this.canvasContext.setFillStyle(s),this.canvasContext.setFontSize(a),this.canvasContext.setTextAlign("center"),this.params.debug&&console.log(`环形文字的坐标--x:${r+l},y:${c+t+a/4+2}`),this.canvasContext.fillText(e,r+l,c+t+a/4+2),this.canvasContext.draw(!0)}async previewPoster(){return await this._canvasToTempFilePath(),console.log("预览海报,海报临时地址:",this.posterImgSrc),new Promise((t,e)=>{this.posterImgSrc?o.a.previewImage({current:this.posterImgSrc,urls:[this.posterImgSrc]}).then(()=>{t()}).catch(t=>{e(t)}):(console.log("海报图地址获取失败,海报临时地址:",this.posterImgSrc),e("海报图地址获取失败,海报临时地址:"))})}async savePosterToPhoto(){let a=this;await this._canvasToTempFilePath();let s=this.posterImgSrc;return this.params.debug&&(console.time("canvas图片保存"),console.log("开始保存图片到相册",s)),new Promise((t,e)=>{o.a.saveImageToPhotosAlbum({filePath:s,success(){o.a.hideToast(),t("图片保存到相册"),console.log("成功保存图片到相册",s),a.params.debug&&console.timeEnd("canvas图片保存")},fail:function(t){console.log(333,t),o.a.hideLoading(),console.log(444,t),a.getAuth(),e(t)}})})}getAuth(){o.a.hideLoading(),this.params.debug&&console.log("拒绝保存"),o.a.showModal({content:"需要您授权保存相册",confirmColor:"#E23A4E",showCancel:!1,success:t=>{o.a.openSetting({success(t){console.log("settingdata",t),t.authSetting["scope.writePhotosAlbum"]?o.a.showToast({title:"获取权限成功,再次点击图片即可保存",icon:"none",duration:3e3}):o.a.showToast({title:"获取权限失败，将无法保存到相册",icon:"none",duration:3e3})},fail(t){console.log("failData",t)},complete(t){console.log("finishData",t)}})}})}_downloadFile(s){return this.params.debug&&(console.log("开始下载网络图片",s),console.time("网络图片下载时间",s)),-1==s.indexOf("http")?Promise.resolve(s):new Promise(async(t,e)=>{try{var a=await o.a.downloadFile({url:s});this.params.debug&&(console.log("网络图片下载成功",a.tempFilePath),console.timeEnd("网络图片下载时间",s)),t(a.tempFilePath)}catch(t){this.params.debug&&console.log("网络图片下载失败"),e(t)}})}_canvasToTempFilePath(){return this.posterImgSrc?(console.log("canvas临时文件已存在",this.posterImgSrc),Promise.resolve(this.posterImgSrc)):new Promise((e,a)=>{setTimeout(async()=>{try{this.params.debug&&(console.log("开始截取canvas目前的图像"),console.time("canvas截取图片"));var t=await o.a.canvasToTempFilePath({x:0,y:0,quality:this.params.quality,canvasId:this.params.canvasId});this.params.debug&&(console.log("截取canvas目前的图像成功",t.tempFilePath),console.timeEnd("canvas截取图片")),this.posterImgSrc=t.tempFilePath,e()}catch(t){a(t)}},300)})}}},function(t,e){t.exports=a}],o.c=n,o.d=function(t,e,a){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(o.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)o.d(a,s,function(t){return e[t]}.bind(null,s));return a},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0).default;function o(t){if(n[t])return n[t].exports;var e=n[t]={i:t,l:!1,exports:{}};return s[t].call(e.exports,e,e.exports,o),e.l=!0,e.exports}var s,n});